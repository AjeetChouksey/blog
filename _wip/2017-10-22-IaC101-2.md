---
layout: post
title: IaC - 2 - ARM Templates
description: "IaC - 2 - ARM Templates"
modified: 2017-10-22
tags: [Azure, IaC, DevOps]
categories: [Azure]
author: Ajeet
---
Objective of this lab is 

1. Option to create 'n' number of VMs associated with dedicated stroage accounts along and public IPs. All these VMs share one common storage account for diagonistics.

2.  Virtual network with one subnet. 

3.  Create Azure SQL server instance along with database.

4. All of these resources will reside inside a single resouce group.

5. Use VSTS CI/CD pipeline for deployment.

**copy and copyIndex()**
This function is used to itrativley deploy the resource. So if you would like to create any resource more than once use copyIndex() function, by definging the count.  

![](/images/posts/iac/iaclab2_arch.JPG)

```JSON
"vmCount":{
      "type": "int",
      "defaultValue": 2,
      "metadata": {
        "value": "number of VM"
      }
    },
```
**SQL Server**

```JSON
  "sqlAdminLogin": {
      "type": "string",
      "defaultValue": "sqladmin",
      "metadata": { "description": "Azure SQL Admin for Service" }
    },
   "sqlAdminPassword": {
      "type": "securestring",
      "metadata": { "description": "SQL Admin Password " }
    },
    "azureSqlServerName": {
      "type": "string",
      "defaultValue": "iaclab2",
      "metadata": { "description": "Azure SQL Database Server Instance Name for Service" }
    },
    "azureSqlDbName": {
      "type": "string",
      "defaultValue": "iaclab2db",
      "metadata": { "description": "Azure SQL Database Name for Service" }
    },
    "azureSqlEdition": {
      "type": "string",
      "defaultValue": "Basic",
      "allowedValues": [
        "Basic",
        "Business",
        "Premium",
        "Standard",
        "Web"
      ],
      "metadata": { "description": "Azure SQL Database Server Edition for Service" }
    },
    "azureSQLCollation": {
      "type": "string",
      "defaultValue": "SQL_Latin1_General_CP1_CI_AS",
      "metadata": { "description": "Azure SQL Database Collation" }
    }
```

**Storage Account**

```JSON
    {
      "comments": "Create storage accounts for VMs",
      "type": "Microsoft.Storage/storageAccounts",
      "name": "[concat(variables('storageProperty').namePrefix,copyIndex())]",
      "apiVersion": "2016-01-01",
      "location": "[resourceGroup().location]",
      "copy": {
        "name": "StorageAccountLoop",
        "count": "[parameters('vmCount')]",
        "mode":"Parallel"
      },
      "tags": {
         "displayName": "[concat(variables('storageProperty').namePrefix,copyIndex())]"
       },
      "sku": {
         "name": "[variables('storageProperty').accountType]"
      },
      "kind": "Storage"
    },
    {
      "comments": "Create storage accounts for digonistics",
      "type": "Microsoft.Storage/storageAccounts",
      "name": "[variables('storageProperty').digonisticStorage]",
      "apiVersion": "2016-01-01",
      "location": "[resourceGroup().location]",    
      "tags": {
         "displayName": "[variables('storageProperty').digonisticStorage]"
      },
      "sku": {
        "name": "[variables('storageProperty').accountType]"
      },
     "kind": "Storage"
     },
```

**NIC with Public IP**

```JSON
{
      "comments": "Create NIC VMs",
      "apiVersion": "2016-03-30",
      "type": "Microsoft.Network/networkInterfaces",
      "name":   "[concat(variables('networkProperty').nicName,copyIndex())]",    
      "location": "[resourceGroup().location]",
      "copy": {
        "name": "NICLoop",
        "count": "[parameters('vmCount')]",
        "mode":"Parallel"
    },
      "tags": {
        "displayName":   "[concat(variables('networkProperty').nicName,copyIndex())]"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Network/publicIPAddresses/', concat(variables('publicIPProperty').publicIPAddressName,copyIndex()))]",
        "[resourceId('Microsoft.Network/virtualNetworks/', variables('networkProperty').virtualNetworkName)]"
      ],
      "properties": {
        "ipConfigurations": [
          {
            "name": "ipconfig1",
            "properties": {
              "privateIPAllocationMethod": "Dynamic",
              "publicIPAddress": {
                "id": "[resourceId('Microsoft.Network/publicIPAddresses', concat(variables('publicIPProperty').publicIPAddressName,copyIndex()))]"
              },
              "subnet": {
                "id": "[variables('subnetRef')]"
              }
            }
          }
        ]
      }
    },

```

**Deployment Result**

![](/images/posts/iac/Iaclab2.JPG)

[Get Complete Code](https://github.com/AjeetChouksey/IaCLab/tree/master/IaC101_2)

[Best practices for creating Azure Resource Manager templates](https://docs.microsoft.com/en-us/azure/azure-resource-manager/resource-manager-template-best-practices)