---
layout: post
title: IaC
description: "IaC ARM 101"
modified: 2017-10-16
tags: [Azure, IaC, DevOps]
categories: [Azure]
author: Ajeet
---
## Understand the solution/ code structure
	
You can use any authoring tool like VisualStudio, VisualStudio code, notepad++ etc. to start writing IaC code. Please make sure you install Azure SDK/ Azure RM plugin (to work with VS code).

<<link Azure SDK>>
<<image RM plugin>>
		
Azure RM have 3 main files as a part of IaC solution.
		
<<azure solution image>>
		
*   Azuredeploy.json: this is first file where we write actual code (better to call orchestration). 

*   Azuredeploy.parameters.json: this parameter JSON file is used to store parameter values provided by the users at the time of deployment. You can either hardcode these values, or you can provide these values on run time.

*   Deploy.ps1: this PowerShell is use to run some validations/ checks, also if define it create a stagining artifacts storage to upload and later download files securely using SAS token.
	
	Will explain more as we progress.
	
	I am going to use VS code, refer (<<link>>) to know how to create and deploy ARM solution using VisualStudio.
	
    ### azuredeploy.json

```JSON
    {
        "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
        "contentVersion": "1.0.0.0",
        "parameters": {},
        "variables": {},
        "resources": [],
        "outputs": {}
    }

```
*   *schema*: Location of the JSON schema file that describes the version of the template language. You should use the URL shown above.
*  *contentVersion*: Version of the template (such as 1.0.0.0). You can provide any value for this element. When deploying resources using the template, this value can be used to make sure that the right template is being used.
*    *parameters*: Values that are provided when deployment is executed to customize resource deployment.
*   *variables*: Values that are used as JSON fragments in the template to simplify template language expressions.
*    *resources*: Resource types that are deployed or updated in a resource group.
*   *outputs*: Values that are returned after deployment.
	  
### azuredeploy.parameters.json
```JSON
  {
        "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
        "contentVersion": "1.0.0.0",
        "parameters": {
        }
  }
```      
## azuredeploy.json

#### parameters

This section is used to recive input from the user. You need to provide parameter name and it's type.

```JSON
  {
        "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
        "contentVersion": "1.0.0.0",
        "parameters": {
            "<<paramName>>":{
            "type": "string"
            }
        }
  }
```
 You can also add input validation by using various property.

```JSON
{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
        "vmAdminName":{
          "type":"string",
          "defaultValue": "localadmin",
          "minLength": 4,
          "maxLength": 10,
          "metadata": {"value":"VM local admin name"}
        },
        "vmAdminPassword":{
          "type":"securestring",
          "minLength": 4,
          "maxLength":8,
          "metadata": {"value":"VM local admin password"}
        },
        "vmSize":{
          "type": "string",
          "defaultValue": "Standard_D2s_v3",
          "allowedValues":[
            "Standard_D2s_v3",
            "Standard_D4s_v3",
            "Standard_D8s_v3"
            ],
            "metadata": {"value":"VM Size"}
        }       
  },
  "variables": {},
  "resources": [],
  "outputs": {}
}
```     
#### Parameter properties
     
**"type"**: type of input parameter. (string, array, bool, int, object, secureObject, secureString)     
**"minLength"**: minimum length for the string or array type.     
**"maxLength"**: maximum length for the string or array type.     
**"minValue"**: minimum value for the int type parameter.     
**"maxValue"**: maximum value for the int type parameter.     
**"allowedValues"**: values can be only one of listed values.     
**"defaultValues"**: value to be used if one is not provided.
    
#### variables
In the  section, you construct values that can be used throughout your template. You do not need to define variables, but they often simplify your template by reducing complex expressions.

```JSON
    {
        "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
        "contentVersion": "1.0.0.0",
        "parameters": {},
        "variables": {
           "<variable-name>": "<variable-value>",
            "<variable-name>": { 
                <variable-complex-type-value> 
            }
        },
        "resources": [],
        "outputs": {}
    }   
}
```

You can simple define the variables, but I like to group variables into complex objects. Use the variable.subentry format to reference a value from a complex object. Grouping variables can help you track related variables. It also improves readability of the template. Here's an example:

```JSON
 {
        "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
        "contentVersion": "1.0.0.0",
        "parameters": {},
        "variables": {
            "storageProperty":{
                    "namePrefix": "[concat(uniquestring(resourceGroup().id),'storage')]",
                    "accountType": "Standard_LRS",
            },
            "vmProperty":{
                      "imageSku": "2016-Datacenter-with-Containers",
                      "imagePublisher": "MicrosoftWindowsServer",
                      "imageOffer": "WindowsServer",
                      "imageVersion": "latest",
                      "OSDiskName": "[concat(parameters('VMName'),'_osdisk')]",
                      "vmStorageAccountContainerName": "vhds",
            },
          "networkProperty":{
                    "nicName": "[concat(parameters('VMName'),'_nic')]",
                    "addressPrefix": "10.0.0.0/16",
                    "subnetName": "[concat(parameters('VMName'),'_subnet')]",
                    "subnetPrefix": "10.0.0.0/24",
                    "virtualNetworkName": "[concat(parameters('VMName'),'_vnet')]",
                    "vnetID": "[resourceId('Microsoft.Network/virtualNetworks',variables('virtualNetworkName'))]",
                    "subnetRef": "[concat(variables('vnetID'),'/subnets/',variables('subnetName'))]",
                    "publicIPAddressName": "[concat(parameters('VMName'),'_pubip')]",
                    "publicIPAddressType": "Dynamic",
          }
        },
        "resources": [],
        "outputs": {}
    }   
}
```
#### resources
Here we define the resources that are deployed or updated. This section can get complicated because you must understand the types you are deploying to provide the right values. For the resource-specific values (apiVersion, type, and properties) that you need to set.

```JSON
   {
        "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
        "contentVersion": "1.0.0.0",
        "parameters": {},
        "variables": {},
        "resources": [
           {
                "condition": "<boolean-value-whether-to-deploy>",
                "apiVersion": "<api-version-of-resource>",
                "type": "<resource-provider-namespace/resource-type-name>",
                "name": "<name-of-the-resource>",
                "location": "<location-of-resource>",
                "tags": {
                    "<tag-name1>": "<tag-value1>",
                    "<tag-name2>": "<tag-value2>"
                },
                "comments": "<your-reference-notes>",
                "copy": {
                    "name": "<name-of-copy-loop>",
                    "count": "<number-of-iterations>",
                    "mode": "<serial-or-parallel>",
                    "batchSize": "<number-to-deploy-serially>"
                },
                "dependsOn": [
                    "<array-of-related-resource-names>"
                ],
                "properties": {
                    "<settings-for-the-resource>",
                    "copy": [
                        {
                            "name": ,
                            "count": ,
                            "input": {}
                        }
                    ]
                },
                "resources": [
                    "<array-of-child-resources>"
                ]
            }
        ],
        "outputs": {}
    }
```
| Element name        	| Required  | Description    	|

| condition        	| No       | Boolean value that indicates whether the resource is deployed. |    
| apiVersion        	| Yes       | Version of the REST API to use for creating the resource. | 
| type  | Yes  | Type of the resource. This value is a combination of the namespace of the resource provider and the resource type (such as Microsoft.Storage/storageAccounts).  |   
| name  | Yes  | Name of the resource. The name must follow URI component restrictions defined in RFC3986. In addition, Azure services that expose the resource name to outside parties validate the name to make sure it is not an attempt to spoof another identity.  |         
| location  | Varies  | upported geo-locations of the provided resource. You can select any of the available locations, but typically it makes sense to pick one that is close to your users. Usually, it also makes sense to place resources that interact with each other in the same region. Most resource types require a location, but some types (such as a role assignment) do not require a location.   |         
| tags  | No  | Tags that are associated with the resource.  |       
| comments  | No  | Your notes for documenting the resources in your template  | 
| copy | No  | If more than one instance is needed, the number of resources to create. The default mode is parallel. Specify serial mode when you do not want all or the resources to deploy at the same time.   | 
| dependsOn   | No  | Resources that must be deployed before this resource is deployed. Resource Manager evaluates the dependencies between resources and deploys them in the correct order. When resources are not dependent on each other, they are deployed in parallel. The value can be a comma-separated list of a resource names or resource unique identifiers. Only list resources that are deployed in this template. Resources that are not defined in this template must already exist. Avoid adding unnecessary dependencies as they can slow your deployment and create circular dependencies.  | 
| properties  | No   | Resource-specific configuration settings. The values for the properties are the same as the values you provide in the request body for the REST API operation (PUT method) to create the resource. You can also specify a copy array to create multiple instances of a property.  |           
| resources  | No  | Child resources that depend on the resource being defined. Only provide resource types that are permitted by the schema of the parent resource. The fully qualified type of the child resource includes the parent resource type, such as Microsoft.Web/sites/extensions. Dependency on the parent resource is not implied. You must explicitly define that dependency.  |    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             	|


### Best practices for creating Azure Resource Manager templates
![Best practices for creating Azure Resource Manager templates](https://docs.microsoft.com/en-us/azure/azure-resource-manager/resource-manager-template-best-practices)